foreach (var swiftTag in listOfTags)
{
    var tagRegex = new Regex(@":(?<Tag>\d{2,3}[A-Z]?):(?<Value>.*)", RegexOptions.Singleline);
    var tagMatches = tagRegex.Matches(swiftTag);

    foreach (Match tagMatch in tagMatches)
    {
        var tag = tagMatch.Groups["Tag"].Value.Trim();
        var value = tagMatch.Groups["Value"].Value.Trim();

        MTTag newTag = new MTTag { Tag = tag, Value = value };

        if (tag.StartsWith("16R"))
        {
            // New block begins
            if (tagStack.Count > 0)
            {
                // Add this new nested block to the current parent
                tagStack.Peek().Body.Add(newTag);
            }
            tagStack.Push(newTag);
        }
        else if (tag.StartsWith("16S"))
        {
            // Block ends
            MTTag completedBlock = tagStack.Pop();

            if (tagStack.Count == 0)
            {
                // We've completed a full root-level block
                textBlock.Add(completedBlock);
            }
        }
        else
        {
            // It's a regular tag â€” add it to current block
            if (tagStack.Count > 0)
            {
                tagStack.Peek().Body.Add(newTag);
            }
        }

        Console.WriteLine($"\tTag: {tag}, Value: {value}");
    }
}
