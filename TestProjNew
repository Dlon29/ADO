=> SwiftInboundConsumer.cs :

public class SwiftInboundConsumer(ILogger<SwiftInboundConsumer> logger,
                             ISubscriber swiftInboundMQSubscriber,
                             ISwiftInboundFactory swiftInboundMQFactory,
                             IRepository swiftInboundMQRepository) : ISwiftInboundConsumer
{
    private readonly ISubscriber _swiftInboundMQSubscriber = swiftInboundMQSubscriber;
    private readonly IRepository _swiftInboundRepository = swiftInboundMQRepository;
    private readonly ISwiftInboundFactory _swiftInboundFactory = swiftInboundMQFactory;
    private readonly ILogger<SwiftInboundConsumer> _logger = logger;        

    public async Task ConsumeMessagesAsync(CancellationToken ct)
    {
        try
        {                
            _logger.LogInformation("Initializing Swift Inbound Consumer - Loading Tag Component Data.");
            string contextTagCompData = await _swiftInboundRepository.GetSwiftTagComponentDataAsync(ct);

            foreach (var swiftInboundPayload in _swiftInboundMQSubscriber.ReadMessages(ct))
            {
                try
                {
                    _logger.LogInformation("Consumed swift inbound MQ message. Payload: {SwiftInboundPayload}", swiftInboundPayload);
                    
                    var swiftInboundMQList = _swiftInboundFactory.ReadSwiftMessages(contextTagCompData, swiftInboundPayload);

                    if (swiftInboundMQList != null && swiftInboundMQList.Count > 0)
                    {  
                        foreach(var msg in swiftInboundMQList)
                        {
                            await _swiftInboundRepository.AddAsync(msg, ct);
                        }                            
                    }
                }
                catch (Exception payloadEx)
                {
                    _logger.LogError(payloadEx, "Error while processing message payload.");
                }
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Critical error in ConsumeMessagesAsync.");
        }
    }
}

=> SwiftInboundRepository.cs :

public class SwiftInboundRepository(IConfiguration cfg, ILogger<SwiftInboundRepository> logger) : IRepository
{
    private readonly ILogger<SwiftInboundRepository> _logger = logger;
    private readonly string _connString = cfg.GetConnectionString("LAVA") ?? string.Empty;        

    public async Task<string> GetSwiftTagComponentDataAsync(CancellationToken ct)
    {
        _logger.LogInformation("Fetching Swift Tag Component Data from LAVA db.");
        try
        {
            using var conn = new SqlConnection(_connString);
            using (var cmd = new SqlCommand("dbo.p_GetSwiftTagComponentData", conn))
            {
                cmd.CommandType = System.Data.CommandType.StoredProcedure;

                await conn.OpenAsync(ct);
                using var reader = await cmd.ExecuteReaderAsync(ct);
                
                var dt = new DataTable("SwiftTagComponent");
                dt.Load(reader);
                
                return LAVA.SwiftInbound.Subscriber.Core.Common.ConvertObjectToXMLString(dt);
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error fetching Swift Tag Component Data.");
            throw;
        }
    }

    public async Task AddAsync<T>(T swiftInboundMQ, CancellationToken ct) where T : SwiftInboundMQ
{
    _logger.LogInformation("Add MQ swift inbound message to LAVA db. CorrelationID: {CorrelationID}", swiftInboundMQ.CorrelationID);
    try
    {
        using var conn = new SqlConnection(_connString);
        using (var cmd = new SqlCommand("dbo.p_ProcessInboundSwiftMessage_Test", conn))
        {
            cmd.CommandType = System.Data.CommandType.StoredProcedure;
            cmd.Parameters.AddWithValue("@pMsgType", swiftInboundMQ.MessageType);
            cmd.Parameters.AddWithValue("@xmlInboundSwiftMessageData", swiftInboundMQ.InboundSwiftMessageData);
            cmd.Parameters.AddWithValue("@pUserId", swiftInboundMQ.UserID);
            cmd.Parameters.AddWithValue("@pXMLSwiftMessageData", swiftInboundMQ.SwiftMessageData);
            cmd.Parameters.AddWithValue("@IsSuccess", swiftInboundMQ.IsSuccess);
            var IsSuccessParam = new SqlParameter("@IsSuccess", SqlDbType.Bit)
            { 
                Direction = ParameterDirection.Output 
            };
            cmd.Parameters.Add(IsSuccessParam);
            cmd.Parameters.AddWithValue("@pProcessedFileName", swiftInboundMQ.ProcessedFileName);
            await conn.OpenAsync(ct);
            await cmd.ExecuteNonQueryAsync(ct);
        };
        await conn.CloseAsync();
    }
    catch (Exception ex)
    {
        _logger.LogError("Error while adding MQ swift inbound message to LAVA db. CorrelationID: {CorrelationID}. Exception: {ErrorMsg}",
                        swiftInboundMQ.CorrelationID, ex.Message);
        throw;
    }
}

=> SwiftInboundFactory.cs :

public class SwiftInboundFactory : ISwiftInboundFactory
{
    private readonly ILogger<SwiftInboundFactory> _logger;                
    
    public SwiftInboundFactory(ILogger<SwiftInboundFactory> logger, string tagCompData)
    {
        _logger = logger;            
    }
   
    public List<SwiftInboundMQ> ReadSwiftMessages(string tagCompData, string swiftInboundPayload)
    {
        List<SwiftInboundMQ> processedMessages = new List<SwiftInboundMQ>();
        List<KeyValuePair<string, string>> lstMessageFilename = new List<KeyValuePair<string, string>>();
        List<string> lstRawMessages = new List<string>();

        try
        {                
            string[] payloadContent = swiftInboundPayload.Split("$".ToCharArray());

            if (payloadContent != null && payloadContent.Length > 0)
            {
                foreach (string message in payloadContent)
                {                        
                    string mockFileName = Guid.NewGuid().ToString("N") + ".txt";
                   
                    InboundSwiftMessage inboundMessage = ProcessRawMessage(message, tagCompData, mockFileName);

                    if (inboundMessage.IsValidMessage)
                    {                            
                        SwiftInboundMQ mqMessage = UpdateInboundMessagesStatus(inboundMessage);
                        processedMessages.Add(mqMessage);

                        _logger.LogInformation("LAVA" + " - MT" + inboundMessage.MessageType, "Parsed inbound swift message. Mock File - {0}", mockFileName);
                    }
                    else
                    {
                        _logger.LogInformation("Discarded message due to invalid format.");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Exception in ReadSwiftMessages while processing MQ payload.");
        }

        return processedMessages;
    }

    public InboundSwiftMessage ProcessRawMessage(string _message, string tagCompData, string filename)
    {            
        return new InboundSwiftMessage(_message, tagCompData, filename);
    }
   
    public SwiftInboundMQ UpdateInboundMessagesStatus(InboundSwiftMessage message)
    {            
        DataTable dtSwiftTag = LAVA.SwiftInbound.Subscriber.Core.Common.CreateDataTable(message.Text.SwiftTag);
        dtSwiftTag.TableName = "TblTagComp";
        string xmlSwiftData = LAVA.SwiftInbound.Subscriber.Core.Common.GetXMLData(dtSwiftTag);
        xmlSwiftData = xmlSwiftData.Replace("'", "&apos;"); // Escape single quotes
       
        StringBuilder sbSwiftMesage = new StringBuilder();
        StringBuilder sbAttributeList = new StringBuilder();
        
        sbSwiftMesage.Append(
            message.Text["20"].TagValue + ";" + 
            string.Empty + ";" + 
            message.MessageType + ";" + 
            message.MessageText + ";" +
            "Inbound" + ";" + 
            45 + ";" + 
            (message.Text["{108:"] != null ? message.Text["{108:"].TagValue : string.Empty) + ";" + 
            message.Text["20"].TagValue + ";" + 
            message.ApplicationHeaderText.RecipientAddress + "|" 
        );

        sbAttributeList.Append("SwiftMessageId|RelatedSwiftMsgId|SwiftMsgType|MessageText|MessageDirection|MessageStatusId|InboundMUR|InboundReference|RecipientAddress");
        string swiftMessageXml = LAVA.SwiftInbound.Subscriber.Core.Common.ConvertStringToXML(sbSwiftMesage.ToString(), sbAttributeList.ToString(), ';').ToString();
        swiftMessageXml = swiftMessageXml.Replace("'", "&apos;"); 
        
        return new SwiftInboundMQ
        {
            MessageType = message.MessageType,
            InboundSwiftMessageData = swiftMessageXml,
            UserID = "dcolaco", 
            SwiftMessageData = xmlSwiftData,
            IsSuccess = true, 
            ProcessedFileName = message.FileName, 
            CorrelationID = "" 
        };
    }
}

=> Now, since we're subscribing messages from MQ, we'll get the message in the swiftInboundPayload (it can contain multiple messages , we're separating them with '$' similarly as in the .NET 4.8 project) 
I've kept the Common.cs, InboundSwiftMessage.cs, ApplicationHeaderBlock.cs, BasicHeaderBlock.cs, Sequence.cs, SwiftBlock.cs, SwiftTag.cs, TextBlock.cs, UserHeaderBlock.cs classes as it is , no change (correct me if I'm wrong)


Here is the issue, I've created two class library projects (Core & Shared) this Interface is in the Shared project which is inherited by SwiftInboundFactory class in the Core project, the methods ProcessRawMessage & UpdateInboundMessagesStatus contain 
reference to class InboundSwiftMessage which is in the Core project, I'm stuck since the Core project is already referring the Shared project and the Shared project cannot refer Core and it will create a 'Cycle' error and also I can't move the InboundSwiftMessage class 
in the shared project since it contains logger and other logic, which I've already shared with you. Now, when I run this the interface cannot find references to InboundSwiftMessage class. What is the best solution for this Architectural issue.


 public interface ISwiftInboundFactory
 {              
     List<SwiftInboundMQ> ReadSwiftMessages(string tagCompData, string swiftInboundPayload);
     InboundSwiftMessage ProcessRawMessage(string _message, string tagCompData, string filename);
     SwiftInboundMQ UpdateInboundMessagesStatus(InboundSwiftMessage message);
 }
