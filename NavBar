// MQ inbound â€“ SAME logic, different transport
public List<string> ReadSwiftMessagesFromMQ(
    string mqPayload,
    string correlationId,
    string tagCompData,
    FtpConfigurationElement item)
{
    List<string> lstMessages = new();
    List<KeyValuePair<string, string>> lstMessageFilename = new();

    try
    {
        ApplicationHeaderBlock applicationHeader =
            new ApplicationHeaderBlock(mqPayload);

        string[] filterMessageType =
            (item.MessageTypes.Replace(Constants.CONS_MESSAGETYPESTART, ""))
            .Split('|');

        if (!filterMessageType.Contains(applicationHeader.MessageType))
            return lstMessages;

        lstMessages.Add(mqPayload);
        lstMessageFilename.Add(
            new KeyValuePair<string, string>(correlationId, mqPayload));

        InboundSwiftMessageCollection swiftMessages =
            new InboundSwiftMessageCollection(
                lstMessages,
                tagCompData,
                lstMessageFilename);

        if (swiftMessages.Count > 0)
        {
            SwiftInbound.UpdateInboundMessagesStatus(
                swiftMessages,
                item.DBName);
        }
    }
    catch (Exception ex)
    {
        _logger.LogErrorMessage(
            item.DBName + " - " + item.MessageTypes,
            Constants.CONS_INBOUND_SWIFTMESSAGE_INVALID,
            ex,
            true,
            nameof(ReadSwiftMessagesFromMQ),
            new[] { "CorrelationId" },
            correlationId
        );
    }

    return lstMessages;
}




public async Task ConsumeMessagesAsync(CancellationToken ct)
{
    try
    {
        foreach (var mqMessage in _swiftInboundMQSubscriber.ReadMessages(ct))
        {
            try
            {
                _logger.LogInformation(
                    "Consumed swift inbound MQ message. CorrelationId: {CorrelationId}",
                    mqMessage.CorrelationId
                );

                _swiftInboundFactory.ReadSwiftMessagesFromMQ(
                    mqMessage.Payload,
                    mqMessage.CorrelationId,
                    _tagCompData,
                    _ftpConfigurationElement
                );
            }
            catch (Exception payloadEx)
            {
                _logger.LogError(
                    payloadEx,
                    "Error processing MQ message. CorrelationId: {CorrelationId}",
                    mqMessage.CorrelationId
                );
            }
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error while consuming MQ messages.");
    }
}




public async Task AddAsync(SwiftInboundMQ swiftInboundMQ, CancellationToken ct)
{
    _logger.LogInformation(
        "Add MQ swift inbound message to LAVA db. CorrelationID: {CorrelationID}",
        swiftInboundMQ.CorrelationID);

    try
    {
        using var conn = new SqlConnection(_connString);
        using var cmd = new SqlCommand("dbo.p_ProcessInboundSwiftMessage", conn)
        {
            CommandType = CommandType.StoredProcedure
        };

        cmd.Parameters.AddWithValue("@pMsgType", swiftInboundMQ.MessageType);
        cmd.Parameters.AddWithValue("@xmlInboundSwiftMessageData", swiftInboundMQ.InboundSwiftMessageData);
        cmd.Parameters.AddWithValue("@pUserId", swiftInboundMQ.UserID);
        cmd.Parameters.AddWithValue("@pXMLSwiftMessageData", swiftInboundMQ.SwiftMessageData);
        cmd.Parameters.AddWithValue("@pProcessedFileName", swiftInboundMQ.ProcessedFileName);

        // OUTPUT parameter (critical)
        var isSuccessParam = new SqlParameter("@IsSuccess", SqlDbType.Bit)
        {
            Direction = ParameterDirection.Output
        };
        cmd.Parameters.Add(isSuccessParam);

        await conn.OpenAsync(ct);
        await cmd.ExecuteNonQueryAsync(ct);

        swiftInboundMQ.IsSuccess =
            isSuccessParam.Value != DBNull.Value &&
            Convert.ToBoolean(isSuccessParam.Value);
    }
    catch (Exception ex)
    {
        _logger.LogError(
            "Error in method SaveInboundMessage. CorrelationID: {CorrelationID}",
            swiftInboundMQ.CorrelationID,
            ex);

        // Preserve legacy semantic behavior
        throw new Exception(Constants.CONS_METHOD_SAVEINBOUNDMESSAGE);
    }
}
