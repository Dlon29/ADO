public sealed class SwiftFileInfo
{
    public int SwiftMsgId { get; set; }
    public string FileName { get; set; } = string.Empty;
}


public async Task<List<SwiftFileInfo>> GetSwiftFileNamesAsync(CancellationToken ct)
{
    var results = new List<SwiftFileInfo>();

    using var conn = new SqlConnection(_connString);
    using var cmd = new SqlCommand("dbo.p_GetSwiftFileNames", conn)
    {
        CommandType = CommandType.StoredProcedure
    };

    await conn.OpenAsync(ct);

    using var reader = await cmd.ExecuteReaderAsync(ct);
    while (await reader.ReadAsync(ct))
    {
        results.Add(new SwiftFileInfo
        {
            SwiftMsgId = reader.GetInt32(0),
            FileName   = reader.GetString(1)
        });
    }

    return results;
}


var files = await _swiftInboundRepository.GetSwiftFileNamesAsync(ct);

var successfulAckIds = new List<int>();

foreach (var file in files)
{
    try
    {
        var ackMessage = $"{file.FileName}|ACK";

        await _swiftInboundMQPublisher.Publish(ackMessage, null, ct);

        // Only add AFTER successful publish
        successfulAckIds.Add(file.SwiftMsgId);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex,
            "Failed to publish ACK for SwiftMsgId {SwiftMsgId}", file.SwiftMsgId);
    }
}



if (successfulAckIds.Count == 0)
{
    _logger.LogWarning("No ACK messages were successfully published. Skipping DB update.");
    return;
}

var statusXml = new XElement(
    "Records",
    successfulAckIds.Select(id =>
        new XElement("Record",
            new XElement("SwiftMsgId", id),
            new XElement("ACKStatus", "ACK")
        ))
);

await _swiftInboundRepository.UpdateSwiftACKStatusAsync(statusXml.ToString(), ct);


while (!ct.IsCancellationRequested)
{
    try
    {
        var consumeTask = _swiftInboundMQConsumer.ConsumeMessagesAsync(ct);
        var publishTask = _swiftInboundMQConsumer.PublishMessagesAsync(ct);

        await Task.WhenAll(consumeTask, publishTask);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error while consuming swift MQ messages.");
    }
    finally
    {
        await Task.Delay(TimeSpan.FromSeconds(_appSettings.RetryInterval), ct);
    }
}
