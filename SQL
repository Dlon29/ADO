CREATE PROCEDURE [dbo].[p_UpdateCDSMQPositionStatus_XML]
(
    @TxnList XML = NULL    -- Example: <TxnList><Txn RequestId="101" Status="200"/><Txn RequestId="102" Status="300"/></TxnList>
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @IsDeleted BIT = 0;
    DECLARE @StatusNotProcessed INT = 100;
    DECLARE @hdoc INT;
    DECLARE @RequestId INT;
    DECLARE @NewStatus INT;
    DECLARE @Min INT, @Max INT, @ID INT;

    -- Temporary table for XML-parsed data
    DECLARE @TempXMLTable TABLE
    (
        ID INT IDENTITY(1,1),
        RequestId INT,
        NewStatus INT
    );

    BEGIN TRY
        BEGIN TRAN;

        -- Parse XML
        IF @TxnList IS NOT NULL
        BEGIN
            EXEC sp_xml_preparedocument @hdoc OUTPUT, @TxnList;

            INSERT INTO @TempXMLTable (RequestId, NewStatus)
            SELECT
                RequestId,
                Status
            FROM
                OPENXML(@hdoc, '/TxnList/Txn', 1)
                WITH (
                    RequestId INT,
                    Status INT
                );

            EXEC sp_xml_removedocument @hdoc;
        END

        -- Option 1: Loop (like your dashboard proc)
        SELECT @Min = MIN(ID), @Max = MAX(ID) FROM @TempXMLTable;

        WHILE @Min IS NOT NULL AND @Min <= @Max
        BEGIN
            SELECT 
                @RequestId = RequestId,
                @NewStatus = NewStatus
            FROM @TempXMLTable WHERE ID = @Min;

            UPDATE dbo.CDSMQ_Position
            SET 
                [Status] = @NewStatus,
                ModifiedOn = GETDATE()
            WHERE 
                RequestId = @RequestId
                AND [Status] = @StatusNotProcessed
                AND IsDeleted = @IsDeleted;

            IF @@ROWCOUNT = 0
            BEGIN
                PRINT CONCAT('No rows updated for RequestId: ', @RequestId);
            END

            SET @Min += 1;
        END

        COMMIT TRAN;
    END TRY
    BEGIN CATCH
        ROLLBACK TRAN;
        DECLARE @ErrMsg NVARCHAR(4000), @ErrSeverity INT;
        SELECT @ErrMsg = ERROR_MESSAGE(), @ErrSeverity = ERROR_SEVERITY();
        RAISERROR(@ErrMsg, @ErrSeverity, 1);
    END CATCH;

    SET NOCOUNT OFF;
END
GO
