CREATE PROCEDURE [dbo].[p_UpdateCDSMQPositionStatus_XML]
(
    @RequestListXML XML = NULL   -- XML input: <RequestList><Request RequestId="..." Status="..."/></RequestList>
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @IsDeleted BIT = 0;
    DECLARE @StatusNotProcessed INT = 100;
    DECLARE @hdoc INT;

    -- Table to hold parsed XML
    DECLARE @TempXMLTable TABLE
    (
        ID INT IDENTITY(1,1),
        RequestId INT,
        NewStatus INT
    );

    BEGIN TRY
        BEGIN TRAN;

        -- Parse XML input
        IF @RequestListXML IS NOT NULL
        BEGIN
            EXEC sp_xml_preparedocument @hdoc OUTPUT, @RequestListXML;

            INSERT INTO @TempXMLTable (RequestId, NewStatus)
            SELECT
                RequestId,
                Status
            FROM
                OPENXML(@hdoc, '/RequestList/Request', 1)
                WITH (
                    RequestId INT,
                    Status INT
                );

            EXEC sp_xml_removedocument @hdoc;
        END

        -- âœ… Set-based bulk update (faster and cleaner than looping)
        UPDATE P
        SET 
            P.[Status] = X.NewStatus,
            P.ModifiedOn = GETDATE()
        FROM dbo.CDSMQ_Position AS P
        INNER JOIN @TempXMLTable AS X
            ON P.RequestId = X.RequestId
        WHERE
            P.[Status] = @StatusNotProcessed
            AND P.IsDeleted = @IsDeleted;

        COMMIT TRAN;
    END TRY
    BEGIN CATCH
        ROLLBACK TRAN;
        DECLARE @ErrMsg NVARCHAR(4000), @ErrSeverity INT;
        SELECT @ErrMsg = ERROR_MESSAGE(), @ErrSeverity = ERROR_SEVERITY();
        RAISERROR(@ErrMsg, @ErrSeverity, 1);
    END CATCH;

    SET NOCOUNT OFF;
END
GO
